<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>LangPro Enterprise v4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap');
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: #020617;
            color: #e2e8f0;
            overflow: hidden;
        }

        .enterprise-glass {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .audio-bar {
            width: 4px;
            background: #6366f1;
            margin: 0 2px;
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .msg-bubble {
            animation: popIn 0.3s cubic-bezier(0.26, 1.36, 0.4, 1.29);
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center p-6">

    <div id="login-view" class="fixed inset-0 z-50 bg-slate-950 flex items-center justify-center p-6">
        <div class="enterprise-glass p-10 rounded-[40px] max-w-md w-full text-center shadow-2xl">
            <div class="mb-6 inline-block p-4 bg-indigo-600 rounded-3xl rotate-12">
                <i data-lucide="mic-2" class="w-10 h-10 text-white"></i>
            </div>
            <h1 class="text-4xl font-bold mb-2 tracking-tight">LangPro <span class="text-indigo-500 text-lg">v4.0</span></h1>
            <p class="text-slate-500 mb-8">Professional ovozli muloqot tizimi</p>
            
            <input id="in-name" type="text" placeholder="Ismingiz" class="w-full bg-slate-900 border border-slate-800 p-5 rounded-2xl mb-4 outline-none focus:ring-2 ring-indigo-500">
            <select id="in-level" class="w-full bg-slate-900 border border-slate-800 p-5 rounded-2xl mb-8 outline-none text-indigo-400 font-bold">
                <option value="A1">A1 - Beginner</option>
                <option value="B2">B2 - Intermediate</option>
                <option value="C1">C1 - Advanced</option>
            </select>
            
            <button onclick="startSession()" class="w-full bg-indigo-600 hover:bg-indigo-500 p-5 rounded-2xl font-bold transition-all transform active:scale-95 shadow-xl shadow-indigo-600/20">
                Suhbatni boshlash
            </button>
        </div>
    </div>

    <div id="main-view" class="hidden w-full max-w-6xl h-full enterprise-glass rounded-[50px] flex overflow-hidden shadow-2xl">
        
        <aside class="w-24 lg:w-72 border-r border-white/5 p-8 flex flex-col">
            <div class="flex items-center gap-3 mb-12">
                <div class="w-10 h-10 bg-indigo-500 rounded-xl flex items-center justify-center"><i data-lucide="zap" class="w-5 h-5"></i></div>
                <span class="font-bold text-xl hidden lg:block">LangPro</span>
            </div>
            
            <nav class="flex-1 space-y-4">
                <div class="p-4 rounded-2xl bg-indigo-600/10 text-indigo-400 flex items-center gap-4"><i data-lucide="message-circle"></i> <span class="hidden lg:block font-bold">Chat</span></div>
                <div class="p-4 rounded-2xl hover:bg-white/5 text-slate-500 flex items-center gap-4 cursor-not-allowed"><i data-lucide="users"></i> <span class="hidden lg:block">Guruhlar</span></div>
            </nav>

            <div class="mt-auto p-4 bg-slate-900/50 rounded-3xl flex items-center gap-4">
                <div id="my-avatar" class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center font-bold text-white">?</div>
                <div class="hidden lg:block overflow-hidden">
                    <p id="my-name-display" class="font-bold text-sm truncate">User</p>
                    <p class="text-[10px] text-indigo-400">ONLINE</p>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-slate-950/20">
            <header class="p-8 border-b border-white/5 flex justify-between items-center bg-slate-900/20">
                <div class="flex items-center gap-4">
                    <div id="p-status" class="w-3 h-3 rounded-full bg-slate-600 animate-pulse"></div>
                    <h2 id="p-name" class="font-bold text-xl">Suhbatdosh qidirilmoqda...</h2>
                </div>
                
                <div class="flex gap-4 items-center">
                    <div id="visualizer" class="hidden flex items-end h-8 gap-1 px-4 border-r border-white/10">
                        <div class="audio-bar h-2"></div>
                        <div class="audio-bar h-5"></div>
                        <div class="audio-bar h-3"></div>
                    </div>
                    <button id="mic-btn" disabled onclick="toggleMic()" class="w-14 h-14 rounded-2xl bg-red-500/20 text-red-500 flex items-center justify-center transition-all hover:scale-105 border border-red-500/30">
                        <i data-lucide="mic-off" id="mic-icon"></i>
                    </button>
                    <button onclick="location.reload()" class="w-14 h-14 rounded-2xl bg-slate-800 flex items-center justify-center hover:bg-white/10"><i data-lucide="log-out"></i></button>
                </div>
            </header>

            <div id="chat-box" class="flex-1 overflow-y-auto p-8 space-y-6">
                <div id="loader" class="h-full flex flex-col items-center justify-center text-slate-500 space-y-4">
                    <div class="w-12 h-12 border-4 border-indigo-500/20 border-t-indigo-500 rounded-full animate-spin"></div>
                    <p>Global tarmoqdan sherik qidirilmoqda...</p>
                </div>
            </div>

            <div class="p-8">
                <div class="enterprise-glass p-2 rounded-[30px] flex gap-4 shadow-2xl border-white/10">
                    <input id="chat-input" disabled type="text" placeholder="Xabaringizni yozing..." class="flex-1 bg-transparent px-6 py-4 outline-none text-lg">
                    <button id="send-btn" disabled onclick="sendMsg()" class="bg-indigo-600 hover:bg-indigo-500 text-white w-16 h-16 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-600/30 transition-all active:scale-90">
                        <i data-lucide="send"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="audio-bridge" class="hidden"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        lucide.createIcons();
        const socket = io();
        let pc, localStream, isMuted = true;

        const dom = {
            login: document.getElementById('login-view'),
            app: document.getElementById('main-view'),
            chat: document.getElementById('chat-box'),
            mic: document.getElementById('mic-btn'),
            input: document.getElementById('chat-input'),
            send: document.getElementById('send-btn')
        };

        // --- SESSION LOGIC ---
        async function startSession() {
            const name = document.getElementById('in-name').value;
            const level = document.getElementById('in-level').value;
            if(!name) return alert("Ismingizni kiriting!");

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                localStream.getAudioTracks()[0].enabled = false;
                
                document.getElementById('my-name-display').innerText = name;
                document.getElementById('my-avatar').innerText = name[0].toUpperCase();
                
                dom.login.classList.add('hidden');
                dom.app.classList.remove('hidden');
                
                socket.emit('register_user', { name, level });
            } catch (e) {
                alert("Mikrofonga ruxsat bermasangiz ovoz ishlamaydi!");
            }
        }

        // --- WEBRTC ENGINE ---
        socket.on('match_found', async (data) => {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('p-name').innerText = data.partner.name;
            document.getElementById('p-status').classList.replace('bg-slate-600', 'bg-emerald-500');
            
            dom.input.disabled = false;
            dom.send.disabled = false;
            dom.mic.disabled = false;

            initiateRTC(data.role === 'initiator');
        });

        async function initiateRTC(isInitiator) {
            pc = new RTCPeerConnection({
                iceServers: [{ urls: ['stun:stun.l.google.com:19302', 'stun:stun1.l.google.com:19302'] }]
            });

            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

            pc.ontrack = (e) => {
                let remoteAudio = document.getElementById('remote-audio');
                if(!remoteAudio) {
                    remoteAudio = document.createElement('audio');
                    remoteAudio.id = 'remote-audio';
                    remoteAudio.autoplay = true;
                    document.getElementById('audio-bridge').appendChild(remoteAudio);
                }
                remoteAudio.srcObject = e.streams[0];
                document.getElementById('visualizer').classList.remove('hidden');
                animateBars();
            };

            pc.onicecandidate = (e) => {
                if(e.candidate) socket.emit('signal', { candidate: e.candidate });
            };

            if(isInitiator) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.emit('signal', { offer });
            }
        }

        socket.on('signal', async (data) => {
            if(!pc) return;
            try {
                if(data.offer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    socket.emit('signal', { answer });
                } else if(data.answer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                } else if(data.candidate) {
                    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            } catch(e) { console.error("RTC Error", e); }
        });

        // --- CONTROLS ---
        function toggleMic() {
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            
            const icon = document.getElementById('mic-icon');
            dom.mic.className = isMuted ? 
                "w-14 h-14 rounded-2xl bg-red-500/20 text-red-500 flex items-center justify-center border border-red-500/30" : 
                "w-14 h-14 rounded-2xl bg-emerald-500 text-white flex items-center justify-center shadow-lg shadow-emerald-500/40";
            
            icon.setAttribute('data-lucide', isMuted ? 'mic-off' : 'mic');
            lucide.createIcons();
        }

        function sendMsg() {
            const val = dom.input.value.trim();
            if(!val) return;
            socket.emit('message', val);
            addMessage('Siz', val, true);
            dom.input.value = '';
        }

        socket.on('message', d => addMessage(d.user, d.text, false));

        function addMessage(user, text, isMe) {
            const html = `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'} msg-bubble">
                    <div class="max-w-[70%] ${isMe ? 'bg-indigo-600 text-white rounded-t-3xl rounded-bl-3xl' : 'bg-slate-900 text-slate-200 rounded-t-3xl rounded-br-3xl'} p-5 shadow-xl">
                        <p class="text-[10px] opacity-50 mb-1 font-bold">${user}</p>
                        <p class="text-sm leading-relaxed">${text}</p>
                    </div>
                </div>`;
            dom.chat.insertAdjacentHTML('beforeend', html);
            dom.chat.scrollTop = dom.chat.scrollHeight;
        }

        function animateBars() {
            const bars = document.querySelectorAll('.audio-bar');
            setInterval(() => {
                bars.forEach(b => { b.style.height = (Math.random() * 20 + 5) + 'px'; });
            }, 100);
        }

        socket.on('partner_offline', () => {
            document.getElementById('p-name').innerText = "Suhbatdosh tark etdi";
            document.getElementById('p-status').classList.replace('bg-emerald-500', 'bg-red-500');
            dom.input.disabled = true;
            if(pc) pc.close();
        });
    </script>
</body>
</html>